import discord
from discord.ext import commands
import os
import json
import time

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

DATA_FILE = "data.json"
WAR_FILE = "war.json"

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°/ì €ì¥ í•¨ìˆ˜
def load_data():
    try:
        with open(DATA_FILE, "r") as f:
            return json.load(f)
    except:
        return {}

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f)

def load_war():
    try:
        with open(WAR_FILE, "r") as f:
            return json.load(f)
    except:
        return {}

def save_war(war_data):
    with open(WAR_FILE, "w") as f:
        json.dump(war_data, f)

# ìœ ì € ê¸°ë³¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
def get_user(data, user_id):
    if user_id not in data:
        data[user_id] = {
            "money": 0,
            "base_income": 100,
            "extra_income": 0,
            "military": 0,
            "last_income_time": 0,
            "alliance": None
        }
    return data[user_id]

# ìƒì  ê´€ë ¨ ìƒìˆ˜
COST_PER_INCOME = 200
INCOME_INCREASE = 50
COST_PER_MILITARY = 150
MILITARY_INCREASE = 10

# ìˆ˜ìµ ëª…ë ¹ì–´
@bot.command()
async def ìˆ˜ìµ(ctx):
    data = load_data()
    user = get_user(data, str(ctx.author.id))
    now = time.time()
    if now - user["last_income_time"] < 3600:
        await ctx.send("â° 1ì‹œê°„ì— í•œ ë²ˆë§Œ ìˆ˜ìµì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”!")
        return
    total_income = user["base_income"] + user["extra_income"]
    user["money"] += total_income
    user["last_income_time"] = now
    save_data(data)
    await ctx.send(f"ğŸ’° {ctx.author.mention}, {total_income}ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!")

# ì •ë³´ ëª…ë ¹ì–´
@bot.command()
async def ì •ë³´(ctx):
    data = load_data()
    user = get_user(data, str(ctx.author.id))
    embed = discord.Embed(title=f"{ctx.author.name}ì˜ êµ­ê°€ ì •ë³´", color=0x00ff00)
    embed.add_field(name="ğŸ’° ìê¸ˆ", value=f"{user['money']} ê³¨ë“œ")
    embed.add_field(name="ğŸ’µ ê¸°ë³¸ ìˆ˜ìµ", value=f"{user['base_income']}")
    embed.add_field(name="ğŸ“ˆ ì¶”ê°€ ìˆ˜ìµ", value=f"{user['extra_income']}")
    embed.add_field(name="ğŸ”« êµ°ì‚¬ë ¥", value=f"{user['military']}")
    embed.add_field(name="ğŸ¤ ë™ë§¹", value=f"<@{user['alliance']}>" if user["alliance"] else "ì—†ìŒ")
    await ctx.send(embed=embed)

# ë™ë§¹ ëª…ë ¹ì–´
@bot.command()
async def ë™ë§¹(ctx, ëŒ€ìƒ: discord.Member):
    data = load_data()
    user = get_user(data, str(ctx.author.id))
    target = get_user(data, str(ëŒ€ìƒ.id))
    if user["alliance"] or target["alliance"]:
        await ctx.send("ë‘˜ ì¤‘ í•œ ëª…ì´ ì´ë¯¸ ë™ë§¹ ì¤‘ì…ë‹ˆë‹¤.")
        return
    user["alliance"] = str(ëŒ€ìƒ.id)
    target["alliance"] = str(ctx.author.id)
    save_data(data)
    await ctx.send(f"{ctx.author.mention}ë‹˜ê³¼ {ëŒ€ìƒ.mention}ë‹˜ì´ ë™ë§¹ì„ ë§ºì—ˆìŠµë‹ˆë‹¤!")

# ì „ìŸ ëª…ë ¹ì–´
@bot.command()
async def ì „ìŸ(ctx, ëŒ€ìƒ: discord.Member):
    data = load_data()
    war_data = load_war()
    attacker_id = str(ctx.author.id)
    defender_id = str(ëŒ€ìƒ.id)
    if attacker_id == defender_id:
        await ctx.send("ìê¸° ìì‹ ê³¼ ì „ìŸí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    attacker = get_user(data, attacker_id)
    defender = get_user(data, defender_id)
    if attacker["alliance"] == defender_id:
        await ctx.send("ë™ë§¹ê³¼ëŠ” ì „ìŸí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        return
    war_data["active_war"] = {
        "attacker": attacker_id,
        "defender": defender_id,
        "attacker_support": [],
        "defender_support": [],
        "start_time": time.time()
    }
    save_war(war_data)
    await ctx.send(f"âš”ï¸ {ctx.author.mention}ë‹˜ì´ {ëŒ€ìƒ.mention}ë‹˜ì—ê²Œ ì „ìŸì„ ì„ í¬í–ˆìŠµë‹ˆë‹¤!\në™ë§¹ì€ `!ì°¸ì „ @í”Œë ˆì´ì–´`ë¡œ ì°¸ì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n10ë¶„ í›„ `!ê²°ì „`ìœ¼ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

# ì°¸ì „ ëª…ë ¹ì–´
@bot.command()
async def ì°¸ì „(ctx, ëŒ€ìƒ: discord.Member):
    war_data = load_war()
    data = load_data()
    user_id = str(ctx.author.id)
    target_id = str(ëŒ€ìƒ.id)
    if "active_war" not in war_data:
        await ctx.send("í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì „ìŸì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    user = get_user(data, user_id)
    if user["alliance"] != target_id:
        await ctx.send("ì´ ìœ ì €ì˜ ë™ë§¹ì´ ì•„ë‹™ë‹ˆë‹¤.")
        return
    if war_data["active_war"]["attacker"] == target_id:
        if user_id not in war_data["active_war"]["attacker_support"]:
            war_data["active_war"]["attacker_support"].append(user_id)
            save_war(war_data)
            await ctx.send(f"{ctx.author.mention}ë‹˜ì´ ê³µê²© ì¸¡ìœ¼ë¡œ ì°¸ì „í–ˆìŠµë‹ˆë‹¤!")
        else:
            await ctx.send("ì´ë¯¸ ì°¸ì „í–ˆìŠµë‹ˆë‹¤.")
    elif war_data["active_war"]["defender"] == target_id:
        if user_id not in war_data["active_war"]["defender_support"]:
            war_data["active_war"]["defender_support"].append(user_id)
            save_war(war_data)
            await ctx.send(f"{ctx.author.mention}ë‹˜ì´ ìˆ˜ë¹„ ì¸¡ìœ¼ë¡œ ì°¸ì „í–ˆìŠµë‹ˆë‹¤!")
        else:
            await ctx.send("ì´ë¯¸ ì°¸ì „í–ˆìŠµë‹ˆë‹¤.")
    else:
        await ctx.send("ê·¸ ìœ ì €ëŠ” ì „ìŸ ë‹¹ì‚¬ìê°€ ì•„ë‹™ë‹ˆë‹¤.")

# ê²°ì „ ëª…ë ¹ì–´ (10ë¶„ ì œí•œ)
@bot.command()
async def ê²°ì „(ctx):
    war_data = load_war()
    data = load_data()
    if "active_war" not in war_data:
        await ctx.send("í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì „ìŸì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    war = war_data["active_war"]
    now = time.time()
    if now - war["start_time"] < 600:
        ë‚¨ì€ì‹œê°„ = int(600 - (now - war["start_time"]))
        await ctx.send(f"â³ ê²°ì „ì€ ì „ìŸ ì‹œì‘ 10ë¶„ í›„ì— ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‚¨ì€ ì‹œê°„: {ë‚¨ì€ì‹œê°„}ì´ˆ")
        return
    attacker_id = war["attacker"]
    defender_id = war["defender"]
    attacker_power = get_user(data, attacker_id)["military"]
    for uid in war["attacker_support"]:
        attacker_power += get_user(data, uid)["military"]
    defender_power = get_user(data, defender_id)["military"]
    for uid in war["defender_support"]:
        defender_power += get_user(data, uid)["military"]
    result_msg = ""
    if attacker_power > defender_power:
        reward = 300
        get_user(data, attacker_id)["money"] += reward
        get_user(data, defender_id)["money"] = max(0, get_user(data, defender_id)["money"] - reward)
        result_msg = f"âš”ï¸ ê³µê²© ì¸¡ ìŠ¹ë¦¬!\n<@{attacker_id}>ê°€ {reward}ê³¨ë“œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤!"
    elif defender_power > attacker_power:
        penalty = 150
        get_user(data, attacker_id)["money"] = max(0, get_user(data, attacker_id)["money"] - penalty)
        result_msg = f"ğŸ›¡ï¸ ìˆ˜ë¹„ ì¸¡ ìŠ¹ë¦¬!\n<@{attacker_id}>ê°€ {penalty}ê³¨ë“œë¥¼ ìƒì—ˆìŠµë‹ˆë‹¤!"
    else:
        result_msg = "âš–ï¸ ì „ìŸì´ ë¬´ìŠ¹ë¶€ë¡œ ëë‚¬ìŠµë‹ˆë‹¤."
    del war_data["active_war"]
    save_data(data)
    save_war(war_data)
    await ctx.send(result_msg)

# ìƒì  ê¸°ëŠ¥ - ìˆ˜ìµ, êµ°ì‚¬ ê°•í™”
class ShopView(discord.ui.View):
    def __init__(self, user_id):
        super().__init__(timeout=120)
        self.user_id = user_id

    async def purchase(self, interaction, kind, amount):
        data = load_data()
        user = get_user(data, self.user_id)

        if kind == "income":
            cost = COST_PER_INCOME * amount
            if user["money"] >= cost:
                user["money"] -= cost
                user["extra_income"] += INCOME_INCREASE * amount
                await interaction.response.send_message(f"âœ… ìˆ˜ìµì´ {INCOME_INCREASE * amount} ì¦ê°€!", ephemeral=True)
            else:
                await interaction.response.send_message("âŒ ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", ephemeral=True)

        elif kind == "military":
            cost = COST_PER_MILITARY * amount
            if user["money"] >= cost:
                user["money"] -= cost
                user["military"] += MILITARY_INCREASE * amount
                await interaction.response.send_message(f"âœ… êµ°ì‚¬ë ¥ì´ {MILITARY_INCREASE * amount} ì¦ê°€!", ephemeral=True)
            else:
                await interaction.response.send_message("âŒ ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", ephemeral=True)

        save_data(data)

    @discord.ui.button(label="+1 ìˆ˜ìµ ê°•í™” (200ê³¨ë“œ)", style=discord.ButtonStyle.green)
    async def income_1(self, interaction, button):
        if str(interaction.user.id) == self.user_id:
            await self.purchase(interaction, "income", 1)
        else:
            await interaction.response.send_message("ì´ ë²„íŠ¼ì€ ë‹¹ì‹ ì˜ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.", ephemeral=True)

    @discord.ui.button(label="+5 ìˆ˜ìµ ê°•í™” (1000ê³¨ë“œ)", style=discord.ButtonStyle.green)
    async def income_5(self, interaction, button):
        if str(interaction.user.id) == self.user_id:
            await self.purchase(interaction, "income", 5)
        else:
            await interaction.response.send_message("ì´ ë²„íŠ¼ì€ ë‹¹ì‹ ì˜ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.", ephemeral=True)

    @discord.ui.button(label="+1 êµ°ì‚¬ ê°•í™” (150ê³¨ë“œ)", style=discord.ButtonStyle.blurple)
    async def military_1(self, interaction, button):
        if str(interaction.user.id) == self.user_id:
            await self.purchase(interaction, "military", 1)
        else:
            await interaction.response.send_message("ì´ ë²„íŠ¼ì€ ë‹¹ì‹ ì˜ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.", ephemeral=True)

    @discord.ui.button(label="+5 êµ°ì‚¬ ê°•í™” (750ê³¨ë“œ)", style=discord.ButtonStyle.blurple)
    async def military_5(self, interaction, button):
        if str(interaction.user.id) == self.user_id:
            await self.purchase(interaction, "military", 5)
        else:
            await interaction.response.send_message("ì´ ë²„íŠ¼ì€ ë‹¹ì‹ ì˜ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.", ephemeral=True)

@bot.command()
async def ìƒì (ctx):
    await ctx.send("ğŸª ë‚˜ë¼ ìƒì ", view=ShopView(str(ctx.author.id)))

# ë´‡ ì‹¤í–‰
bot.run(os.getenv("MTM5MzQ5NjYwMzg5MjkwODEwMw.GdS2Iq.U9lDwuspQIpDNCDXBDlQBc5kZtTsvw1e2S8n_U"))
