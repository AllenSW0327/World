import discord
from discord.ext import commands
import json
import os
import time

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

DATA_FILE = "data.json"

def load_data():
    if not os.path.isfile(DATA_FILE):
        return {}
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

def country_code_to_emoji(code):
    OFFSET = 127397
    return "".join(chr(ord(c) + OFFSET) for c in code.upper())

# ì „ì„¸ê³„ êµ­ê°€ëª… + ISO ì½”ë“œ (í•œêµ­ì–´ ê¸°ì¤€)
COUNTRY_CODES = {
    "ëŒ€í•œë¯¼êµ­": "KR", "í•œêµ­": "KR", "ë¶í•œ": "KP", "ë¯¸êµ­": "US", "ì¼ë³¸": "JP", "ì¤‘êµ­": "CN",
    "ëŸ¬ì‹œì•„": "RU", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA", "í˜¸ì£¼": "AU",
    "ì¸ë„": "IN", "ë¸Œë¼ì§ˆ": "BR", "ì´íƒˆë¦¬ì•„": "IT", "ìŠ¤í˜ì¸": "ES", "ë©•ì‹œì½”": "MX",
    "í„°í‚¤": "TR", "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„": "SA", "ì´ìŠ¤ë¼ì—˜": "IL", "ì•„ëì—ë¯¸ë¦¬íŠ¸": "AE", "ì‹±ê°€í¬ë¥´": "SG",
    "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­": "ZA", "ë‰´ì§ˆëœë“œ": "NZ", "ìŠ¤ì›¨ë´": "SE", "ë…¸ë¥´ì›¨ì´": "NO", "í•€ë€ë“œ": "FI",
    "í´ë€ë“œ": "PL", "ì²´ì½”": "CZ", "í—ê°€ë¦¬": "HU", "ë²¨ê¸°ì—": "BE", "ë„¤ëœë€ë“œ": "NL",
    "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "AT", "ìŠ¤ìœ„ìŠ¤": "CH", "ê·¸ë¦¬ìŠ¤": "GR", "ì•„ë¥´í—¨í‹°ë‚˜": "AR", "ì½œë¡¬ë¹„ì•„": "CO",
    "í˜ë£¨": "PE", "ì¹ ë ˆ": "CL", "ìš°í¬ë¼ì´ë‚˜": "UA", "ì¹´ìíìŠ¤íƒ„": "KZ", "ë² íŠ¸ë‚¨": "VN",
    "íƒœêµ­": "TH", "ë§ë ˆì´ì‹œì•„": "MY", "í•„ë¦¬í•€": "PH", "ì¸ë„ë„¤ì‹œì•„": "ID", "ë°©ê¸€ë¼ë°ì‹œ": "BD",
    "íŒŒí‚¤ìŠ¤íƒ„": "PK", "ì´ì§‘íŠ¸": "EG", "ì¼€ëƒ": "KE", "ì•Œì œë¦¬": "DZ", "ëª¨ë¡œì½”": "MA",
    "ì•„í”„ê°€ë‹ˆìŠ¤íƒ„": "AF", "ì•Œë°”ë‹ˆì•„": "AL", "ì•ˆë„ë¼": "AD", "ì•™ê³¨ë¼": "AO", "ì•¤í‹°ê°€ ë°”ë¶€ë‹¤": "AG",
    "ì•„ë¥´ë©”ë‹ˆì•„": "AM", "ì•„ì œë¥´ë°”ì´ì”": "AZ", "ë°”í•˜ë§ˆ": "BS", "ë°”ë ˆì¸": "BH", "ë°”ë² ì´ë„ìŠ¤": "BB",
    "ë²¨ë¼ë£¨ìŠ¤": "BY", "ë²¨ë¦¬ì¦ˆ": "BZ", "ë² ëƒ‰": "BJ", "ë¶€íƒ„": "BT", "ë³¼ë¦¬ë¹„ì•„": "BO",
    "ë³´ì¸ ì™€ë‚˜": "BW", "ë¸Œë£¨ë‚˜ì´": "BN", "ë¶ˆê°€ë¦¬ì•„": "BG", "ë¶€ë¥´í‚¤ë‚˜íŒŒì†Œ": "BF", "ë¶€ë£¬ë””": "BI",
    "ìº„ë³´ë””ì•„": "KH", "ì¹´ë©”ë£¬": "CM", "ì¹´ë³´ë² ë¥´ë°": "CV", "ì¤‘ì•™ì•„í”„ë¦¬ì¹´ê³µí™”êµ­": "CF", "ì°¨ë“œ": "TD",
    "ì½”ëª¨ë¡œ": "KM", "ì½©ê³ ê³µí™”êµ­": "CG", "ì½©ê³ ë¯¼ì£¼ê³µí™”êµ­": "CD", "ì½”ìŠ¤íƒ€ë¦¬ì¹´": "CR", "í‚¤í”„ë¡œìŠ¤": "CY",
    "ë´ë§ˆí¬": "DK", "ì§€ë¶€í‹°": "DJ", "ë„ë¯¸ë‹ˆì¹´": "DM", "ë„ë¯¸ë‹ˆì¹´ê³µí™”êµ­": "DO", "ì—ì½°ë„ë¥´": "EC",
    "ì—˜ì‚´ë°”ë„ë¥´": "SV", "ì ë„ê¸°ë‹ˆ": "GQ", "ì—ë¦¬íŠ¸ë ˆì•„": "ER", "ì—ìŠ¤í† ë‹ˆì•„": "EE", "ì—ìŠ¤ì™€í‹°ë‹ˆ": "SZ",
    "ì—í‹°ì˜¤í”¼ì•„": "ET", "í”¼ì§€": "FJ", "ê°€ë´‰": "GA", "ê°ë¹„ì•„": "GM", "ì¡°ì§€ì•„": "GE",
    "ê°€ë‚˜": "GH", "ê·¸ë ˆë‚˜ë‹¤": "GD", "ê´Œ": "GU", "ê³¼í…Œë§ë¼": "GT", "ê¸°ë‹ˆ": "GN",
    "ê¸°ë‹ˆë¹„ì‚¬ìš°": "GW", "ê°€ì´ì•„ë‚˜": "GY", "ì•„ì´í‹°": "HT", "ë°”í‹°ì¹¸": "VA", "ì˜¨ë‘ë¼ìŠ¤": "HN",
    "í™ì½©": "HK", "ì•„ì´ìŠ¬ë€ë“œ": "IS", "ì´ë¼í¬": "IQ", "ì•„ì¼ëœë“œ": "IE", "ìë©”ì´ì¹´": "JM",
    "ìš”ë¥´ë‹¨": "JO", "í‚¤ë¦¬ë°”ì‹œ": "KI", "í‚¤ë¥´ê¸°ìŠ¤ìŠ¤íƒ„": "KG", "ë¼ì˜¤ìŠ¤": "LA", "ë¼íŠ¸ë¹„ì•„": "LV",
    "ë ˆë°”ë…¼": "LB", "ë ˆì†Œí† ": "LS", "ë¼ì´ë² ë¦¬ì•„": "LR", "ë¦¬íˆí…ìŠˆíƒ€ì¸": "LI", "ë¦¬íˆ¬ì•„ë‹ˆì•„": "LT",
    "ë£©ì…ˆë¶€ë¥´í¬": "LU", "ë§ˆë‹¤ê°€ìŠ¤ì¹´ë¥´": "MG", "ë§ë¼ìœ„": "MW", "ëª°ë””ë¸Œ": "MV", "ëª°íƒ€": "MT",
    "ë§ˆì…œì œë„": "MH", "ëª¨ë¦¬íƒ€ë‹ˆ": "MR", "ëª¨ë¦¬ì…”ìŠ¤": "MU", "ë¯¸í¬ë¡œë„¤ì‹œì•„": "FM", "ëª°ë„ë°”": "MD",
    "ëª¨ë‚˜ì½”": "MC", "ëª¬í…Œë„¤ê·¸ë¡œ": "ME", "ëª¨ë¡œì½”": "MA", "ëª¨ì ë¹„í¬": "MZ", "ë¯¸ì–€ë§ˆ": "MM",
    "ë‚˜ë¯¸ë¹„ì•„": "NA", "ë„¤íŒ”": "NP", "ë„¤ëœë€ë“œ": "NL", "ë‰´ì§ˆëœë“œ": "NZ", "ë‹ˆì¹´ë¼ê³¼": "NI",
    "ë‹ˆì œë¥´": "NE", "ë‚˜ì´ì§€ë¦¬ì•„": "NG", "ë…¸ë¥´ì›¨ì´": "NO", "ì˜¤ë§Œ": "OM", "íŒŒí‚¤ìŠ¤íƒ„": "PK",
    "íŒ”ë¼ìš°": "PW", "íŒŒë‚˜ë§ˆ": "PA", "íŒŒí‘¸ì•„ë‰´ê¸°ë‹ˆ": "PG", "íŒŒë¼ê³¼ì´": "PY", "í˜ë£¨": "PE",
    "í•„ë¦¬í•€": "PH", "í´ë€ë“œ": "PL", "í¬ë¥´íˆ¬ê°ˆ": "PT", "ì¹´íƒ€ë¥´": "QA", "ë£¨ë§ˆë‹ˆì•„": "RO",
    "ë¥´ì™„ë‹¤": "RW", "ì„¸ì¸íŠ¸ë£¨ì‹œì•„": "LC", "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„": "SA", "ì„¸ë„¤ê°ˆ": "SN", "ì„¸ë¥´ë¹„ì•„": "RS",
    "ì„¸ì´ì…¸": "SC", "ì‹±ê°€í¬ë¥´": "SG", "ìŠ¬ë¡œë°”í‚¤ì•„": "SK", "ìŠ¬ë¡œë² ë‹ˆì•„": "SI", "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­": "ZA",
    "ë‚¨ìˆ˜ë‹¨": "SS", "ìŠ¤í˜ì¸": "ES", "ìŠ¤ë¦¬ë‘ì¹´": "LK", "ìˆ˜ë‹¨": "SD", "ìˆ˜ë¦¬ë‚¨": "SR",
    "ìŠ¤ì›¨ë´": "SE", "ìŠ¤ìœ„ìŠ¤": "CH", "ì‹œë¦¬ì•„": "SY", "ëŒ€ë§Œ": "TW", "íƒ€ì§€í‚¤ìŠ¤íƒ„": "TJ",
    "íƒ„ìë‹ˆì•„": "TZ", "íƒœêµ­": "TH", "í† ê³ ": "TG", "í†µê°€": "TO", "íŠ¸ë¦¬ë‹ˆë‹¤ë“œí† ë°”ê³ ": "TT",
    "íŠ€ë‹ˆì§€": "TN", "í„°í‚¤": "TR", "íˆ¬ë¥´í¬ë©”ë‹ˆìŠ¤íƒ„": "TM", "ìš°ê°„ë‹¤": "UG", "ìš°í¬ë¼ì´ë‚˜": "UA",
    "ì•„ëì—ë¯¸ë¦¬íŠ¸": "AE", "ì˜êµ­": "GB", "ìš°ë£¨ê³¼ì´": "UY", "ìš°ì¦ˆë² í‚¤ìŠ¤íƒ„": "UZ", "ë°”ëˆ„ì•„íˆ¬": "VU",
    "ë² ë„¤ìˆ˜ì—˜ë¼": "VE", "ë² íŠ¸ë‚¨": "VN", "ì˜ˆë©˜": "YE", "ì ë¹„ì•„": "ZM", "ì§ë°”ë¸Œì›¨": "ZW"
}

COUNTRY_GRADES = {
    "ë¯¸êµ­": "ì´ˆê°•ëŒ€êµ­",
    "ì¤‘êµ­": "ì´ˆê°•ëŒ€êµ­",
    "ëŸ¬ì‹œì•„": "ì´ˆê°•ëŒ€êµ­",

    "ë…ì¼": "ê°•ëŒ€êµ­",
    "ì˜êµ­": "ê°•ëŒ€êµ­",
    "í”„ë‘ìŠ¤": "ê°•ëŒ€êµ­",
    "ì¼ë³¸": "ê°•ëŒ€êµ­",
    "ì¸ë„": "ê°•ëŒ€êµ­",
    "ë¸Œë¼ì§ˆ": "ê°•ëŒ€êµ­",
    "ìºë‚˜ë‹¤": "ê°•ëŒ€êµ­",
    "ëŒ€í•œë¯¼êµ­": "ê°•ëŒ€êµ­",
    "ì´íƒˆë¦¬ì•„": "ê°•ëŒ€êµ­",

    "ìŠ¤í˜ì¸": "ì¤‘ê²¬êµ­",
    "ë©•ì‹œì½”": "ì¤‘ê²¬êµ­",
    "í„°í‚¤": "ì¤‘ê²¬êµ­",
    "ë„¤ëœë€ë“œ": "ì¤‘ê²¬êµ­",
    "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„": "ì¤‘ê²¬êµ­",
    "ìŠ¤ì›¨ë´": "ì¤‘ê²¬êµ­",
    "í´ë€ë“œ": "ì¤‘ê²¬êµ­",
    "ë²¨ê¸°ì—": "ì¤‘ê²¬êµ­",
    "ì•„ë¥´í—¨í‹°ë‚˜": "ì¤‘ê²¬êµ­",
    "ë…¸ë¥´ì›¨ì´": "ì¤‘ê²¬êµ­",
    "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "ì¤‘ê²¬êµ­",
    "ì•„ëì—ë¯¸ë¦¬íŠ¸": "ì¤‘ê²¬êµ­",
    "ì‹±ê°€í¬ë¥´": "ì¤‘ê²¬êµ­",
    "ì´ìŠ¤ë¼ì—˜": "ì¤‘ê²¬êµ­",
    "ë§ë ˆì´ì‹œì•„": "ì¤‘ê²¬êµ­",
    "íƒœêµ­": "ì¤‘ê²¬êµ­",
    "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­": "ì¤‘ê²¬êµ­",
    "ë‰´ì§ˆëœë“œ": "ì¤‘ê²¬êµ­",
    "í•€ë€ë“œ": "ì¤‘ê²¬êµ­",
    "ê·¸ë¦¬ìŠ¤": "ì¤‘ê²¬êµ­",

    # ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ì•½ì†Œêµ­
}

GRADE_STARTING_RESOURCES = {
    "ì´ˆê°•ëŒ€êµ­": {"money": 5000, "military": 500, "base_income": 500},
    "ê°•ëŒ€êµ­": {"money": 3000, "military": 300, "base_income": 300},
    "ì¤‘ê²¬êµ­": {"money": 1000, "military": 100, "base_income": 100},
    "ì•½ì†Œêµ­": {"money": 500, "military": 50, "base_income": 50},
}

GRADE_ROLES = {
    "ì´ˆê°•ëŒ€êµ­": "ì´ˆê°•ëŒ€êµ­",
    "ê°•ëŒ€êµ­": "ê°•ëŒ€êµ­",
    "ì¤‘ê²¬êµ­": "ì¤‘ê²¬êµ­",
    "ì•½ì†Œêµ­": "ì•½ì†Œêµ­",
}

@bot.command()
async def ë‚˜ë¼ìƒì„±(ctx, *, ë‚˜ë¼ì´ë¦„: str):
    data = load_data()
    user_id = str(ctx.author.id)

    if user_id in data:
        await ctx.send(f"{ctx.author.mention} ì´ë¯¸ êµ­ê°€ë¥¼ ìƒì„±í•˜ì…¨ìŠµë‹ˆë‹¤.")
        return

    if ë‚˜ë¼ì´ë¦„ not in COUNTRY_CODES:
        await ctx.send("âŒ ë“±ë¡ëœ êµ­ê°€ëª…ë§Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        return

    grade = COUNTRY_GRADES.get(ë‚˜ë¼ì´ë¦„, "ì•½ì†Œêµ­")
    resources = GRADE_STARTING_RESOURCES[grade]

    data[user_id] = {
        "country_name": ë‚˜ë¼ì´ë¦„,
        "money": resources["money"],
        "base_income": resources["base_income"],
        "extra_income": 0,
        "military": resources["military"],
        "last_income_time": 0,
        "alliance": None,
        "grade": grade
    }
    save_data(data)

    code = COUNTRY_CODES[ë‚˜ë¼ì´ë¦„]
    flag = country_code_to_emoji(code)

    nickname = ctx.author.display_name
    clean_nick = "".join(c for c in nickname if c.isalnum()).lower()

    channel_name = f"{flag}ã…£{ë‚˜ë¼ì´ë¦„}ã…£{clean_nick}"

    guild = ctx.guild
    existing = discord.utils.get(guild.channels, name=channel_name)
    if existing:
        await ctx.send("ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ ì±„ë„ì´ ì¡´ì¬í•©ë‹ˆë‹¤.")
        return

    category = discord.utils.get(guild.categories, name="ğŸŒã…£êµ­ê°€ì •ë³´")
    if category is None:
        category = await guild.create_category("ğŸŒã…£êµ­ê°€ì •ë³´")

    overwrites = {
        guild.default_role: discord.PermissionOverwrite(read_messages=True, send_messages=False),
        ctx.author: discord.PermissionOverwrite(read_messages=True, send_messages=True)
    }

    new_channel = await guild.create_text_channel(channel_name, overwrites=overwrites, category=category)

    role_name = GRADE_ROLES[grade]
    role = discord.utils.get(guild.roles, name=role_name)
    if role is None:
        role = await guild.create_role(name=role_name)

    await ctx.author.add_roles(role)

    await ctx.send(f"{ctx.author.mention} êµ­ê°€ '{ë‚˜ë¼ì´ë¦„}' ({grade}) ìƒì„± ì™„ë£Œ! ì±„ë„ {new_channel.mention} ì´(ê°€) ë§Œë“¤ì–´ì¡Œê³  ì—­í•  '{role_name}' ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰")

bot.run(os.getenv("TOKEN"))
